<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KrakenRelay Repeater Controller</title>

  <style>
    :root{
      --bg: #14151a;
      --panel: #1b1d24;
      --panel2: #161821;
      --border: #2a2d3a;
      --text: #ffffff;
      --muted: #b7bac4;

      --accent: #a259ff;
      --accent2: #37fff8;

      --ok: #3dff47;
      --warn: #ffcc33;
      --bad: #ff5252;

      --shadow: 0 10px 28px rgba(0,0,0,.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(162,89,255,.18), transparent 60%),
                  radial-gradient(900px 500px at 95% 10%, rgba(55,255,248,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      line-height: 1.35;
    }

    /* Header */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(20,21,26,.65);
      backdrop-filter: blur(10px);
    }
    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .logo{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(162,89,255,1), rgba(55,255,248,1));
      box-shadow: 0 0 18px rgba(162,89,255,.3);
    }
    .brand h1{
      margin:0;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .brand .sub{
      display:block;
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
    }

    .status-pills{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size: 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }

    /* Lights */
    .dot{
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #575a66;
      box-shadow: none;
    }
    .dot.rx.on{
      background: var(--ok);
      box-shadow: 0 0 14px rgba(61,255,71,.55);
    }
    .dot.tx.on{
      background: var(--bad);
      box-shadow: 0 0 14px rgba(255,82,82,.55);
    }

    /* Layout */
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Cards */
    .card{
      border: 1px solid rgba(255,255,255,.09);
      background: linear-gradient(180deg, rgba(27,29,36,.92), rgba(22,24,33,.92));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-hd{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .card-hd h2{
      margin:0;
      font-size: 13px;
      letter-spacing: .2px;
      color: rgba(255,255,255,.92);
    }
    .card-bd{
      padding: 14px;
    }

    /* Inputs */
    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    select, input, button{
      font: inherit;
    }
    select, input[type="text"], input[type="number"]{
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }
    input[type="range"]{
      width: 100%;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 980px){
      .row{ grid-template-columns: 1fr; }
    }
    .field{ margin-bottom: 12px; }

    /* Toggle */
    .toggle{
      display:flex;
      align-items:center;
      gap: 10px;
      user-select:none;
      color: var(--muted);
      font-size: 12px;
    }
    .toggle input{ width: 18px; height: 18px; }

    /* Buttons */
    .btnrow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1.5px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      letter-spacing: .2px;
    }
    button:hover{ background: rgba(0,0,0,.28); }
    button:disabled{ opacity: .5; cursor: not-allowed; }

    .btn-primary{
      border-color: rgba(55,255,248,.55);
      box-shadow: 0 0 0 1px rgba(55,255,248,.12), 0 0 18px rgba(55,255,248,.08);
    }
    .btn-danger{
      border-color: rgba(255,82,82,.60);
      box-shadow: 0 0 0 1px rgba(255,82,82,.14), 0 0 18px rgba(255,82,82,.08);
    }
    .btn-ghost{
      color: var(--muted);
    }

    /* Meter */
    .meterWrap{
      display:flex;
      gap: 14px;
      align-items:flex-start;
    }
    .meter{
      width: 34px;
      height: 130px;
      border-radius: 12px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.12);
      overflow:hidden;
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .meterFill{
      position:absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 0%;
      background: linear-gradient(to top, #00ff00, #ffff00 80%, #ff0000);
    }
    .meterMeta{
      flex: 1;
      min-width: 0;
    }
    .metaLine{
      font-size: 12px;
      color: var(--muted);
      margin: 2px 0;
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
      font-size: 12px;
      font-weight: 700;
    }
    .badge.clip{ border-color: rgba(255,82,82,.55); color: rgba(255,82,82,.95); }
    .badge.limit{ border-color: rgba(255,204,51,.55); color: rgba(255,204,51,.95); }
    .badge.hidden{ display:none; }

    /* Progress bars */
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      margin-top: 8px;
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(162,89,255,1), rgba(55,255,248,1));
    }

    /* Section titles */
    .secTitle{
      margin: 0 0 10px;
      font-size: 12px;
      color: rgba(162,89,255,.95);
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .footer{
      margin-top: 12px;
      color: rgba(255,255,255,.38);
      font-size: 11px;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>

  {% set ptt = config.get('ptt', {}) %}
  {% set ptt_primary = ptt.get('primary', {}) %}
  {% set ptt_secondary = ptt.get('secondary', {}) %}

  <div class="section">
    <h2>Config Lock</h2>
    <label style="display:flex;align-items:center;gap:10px;">
      <input type="checkbox" id="cfg-lock" checked>
      <span id="lock-state" style="font-weight:bold;">LOCKED</span>
    </label>
    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <button type="button" id="save-btn">Save Config</button>
      <span id="save-status" style="color:#ccc;"></span>
      <span id="restart-badge" style="display:none; color:#ffcc33; font-weight:bold;">
        Restart required for some changes
      </span>
    </div>
  </div>

  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
        </div>
        <div>
          <h1>KrakenRelay</h1>
          <span class="sub">An Open Source Repeater Controller</span>
          <span class="sub">by American Squid/K3AYV</span>
        </div>
      </div>

      <div class="status-pills">
        <span class="pill"><span class="dot rx" id="rx-dot"></span> RX</span>
        <span class="pill"><span class="dot tx" id="tx-dot"></span> TX</span>
        <span class="pill" id="run-pill">Stopped</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <form id="config-form">

      <div class="grid">

        <!-- LEFT: Live control -->
        <div class="card">
          <div class="card-hd">
            <h2>Live Status</h2>
            <span class="pill" id="ptt-pill">PTT: Not Started</span>
          </div>
          <div class="card-bd">
            <div class="meterWrap">
              <div class="meter">
                <div class="meterFill" id="level-bar"></div>
              </div>

              <div class="meterMeta">
                <div class="metaLine">
                  Audio: <span id="level-text">-60.0 dB</span>
                </div>

                <div class="metaLine">
                  TOT: <span id="tot-text">—</span>
                </div>
                <div class="bar"><div id="tot-bar"></div></div>

                <div class="metaLine" style="margin-top:8px;">
                  Next ID: <span id="next-id-text">—</span>
                  <span id="id-indicator" class="badge" style="display:none;">Sending ID</span>
                  <span id="tot-lockout-indicator" class="badge clip" style="display:none;">TOT Lockout</span>
                </div>

                <div class="metaLine" style="margin-top:10px; gap:10px;">
                  <span id="clip-alert" class="badge clip hidden">CLIPPING</span>
                  <span id="limit-alert" class="badge limit hidden">LIMITING</span>
                </div>
              </div>
            </div>

            <div style="height: 14px;"></div>

            <div class="secTitle">Devices</div>

            <div class="field">
              <label for="input-device">Input Device</label>
              <select id="input-device" name="input_index">
                {% for dev in input_devices %}
                  <option value="{{ dev.index }}">{{ dev.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="field">
              <label for="output-device">Output Device</label>
              <select id="output-device" name="output_index">
                {% for dev in output_devices %}
                  <option value="{{ dev.index }}">{{ dev.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="btnrow">
              <button type="button" id="start-btn" class="btn-primary">Start</button>
              <button type="button" id="stop-btn" class="btn-danger" disabled>Stop</button>
              <button type="button" id="id-btn" class="btn-ghost">Send CW ID</button>
              <button type="button" id="test-ptt" class="btn-ghost">Test PTT</button>
            </div>

            <div class="footer">
              <span id="status-note">Status updates every 500ms</span>
              <span>Open Source Repeater Controller by American Squid/K3AYV</span>
            </div>
          </div>
        </div>

        <!-- RIGHT: Settings -->
        <div class="card">
          <div class="card-hd">
            <h2>Configuration</h2>
            <span class="pill">Config is read-only (for now)</span>
          </div>

          <div class="card-bd">

            <div class="secTitle">Noise Reduction</div>

            <div class="row">
              <div class="field">
                <label for="squelch">Squelch (dB)</label>
                <input type="range" id="squelch" name="squelch_threshold" min="-60" max="-20"
                       value="{{ config.get('audio', {}).get('squelch_threshold', -40) }}" />
                <div class="metaLine">Current: <span id="squelch-value">{{ config.get('audio', {}).get('squelch_threshold', -40) }} dB</span></div>
              </div>

              <div class="field">
                <label>High-pass Filter</label>
                <div class="toggle">
                  <input type="checkbox" id="highpass" name="highpass_enabled"
                    {% if config.get('audio', {}).get('highpass_enabled', True) %}checked{% endif %}>
                  <span>Enable</span>
                </div>

                <label for="highpass-cutoff" style="margin-top:10px;">Cutoff (Hz)</label>
                <input type="range" id="highpass-cutoff" name="highpass_cutoff" min="100" max="1000"
                       value="{{ config.get('audio', {}).get('highpass_cutoff', 300) }}"
                       {% if not config.get('audio', {}).get('highpass_enabled', True) %}disabled{% endif %} />
                <div class="metaLine">Current: <span id="highpass-value">{{ config.get('audio', {}).get('highpass_cutoff', 300) }} Hz</span></div>
              </div>
            </div>

            <div style="height: 12px;"></div>
            <div class="secTitle">Repeater</div>

            <div class="row">
              <div class="field">
                <label for="tail-time">Hang Time (s)</label>
                <input type="number" step="0.1" id="tail-time" name="repeater.tail_time"
                       value="{{ config.get('repeater', {}).get('tail_time', 2.0) }}" />
              </div>
              <div class="field">
                <label for="kerchunk">Anti-Kerchunk (s)</label>
                <input type="number" step="0.1" id="kerchunk" name="repeater.anti_kerchunk_time"
                       value="{{ config.get('repeater', {}).get('anti_kerchunk_time', 0.0) }}" />
              </div>
              <div class="field">
                <label for="carrier-delay">Carrier Delay (s)</label>
                <input type="number" step="0.1" id="carrier-delay" name="repeater.carrier_delay"
                       value="{{ config.get('repeater', {}).get('carrier_delay', 0.0) }}" />
              </div>
              <div class="field">
                <label>Courtesy Tone</label>
                <div class="toggle">
                  <input type="checkbox" id="courtesy-tone" name="repeater.courtesy_tone_enabled"
                    {% if config.get('repeater', {}).get('courtesy_tone_enabled', True) %}checked{% endif %}>
                  <span>Enable</span>
                </div>
              </div>
            </div>

            <div style="height: 12px;"></div>
            <div class="secTitle">Identification</div>

            <div class="row">
              <div class="field">
                <label for="callsign">Callsign</label>
                <input type="text" id="callsign" name="identification.callsign"
                       value="{{ config.get('identification', {}).get('callsign', '') }}" style="text-transform:uppercase;">
              </div>
              <div class="field">
                <label for="id-interval">ID Interval (min)</label>
                <input type="number" id="id-interval" name="identification.interval_minutes" min="1" max="60"
                       value="{{ config.get('identification', {}).get('interval_minutes', 10) }}">
              </div>
              <div class="field">
                <label>CW ID</label>
                <div class="toggle">
                  <input type="checkbox" id="cw-enabled" name="identification.cw_enabled"
                    {% if config.get('identification', {}).get('cw_enabled', True) %}checked{% endif %}>
                  <span>Enable</span>
                </div>
              </div>
              <div class="field">
                <label for="cw-speed">CW Speed (WPM)</label>
                <input type="number" id="cw-speed" name="identification.cw_wpm" min="5" max="30"
                       value="{{ config.get('identification', {}).get('cw_wpm', 20) }}">
              </div>
              <div class="field">
                <label for="cw-pitch">CW Pitch (Hz)</label>
                <input type="number" id="cw-pitch" name="identification.cw_pitch" min="300" max="1200"
                       value="{{ config.get('identification', {}).get('cw_pitch', 523) }}">
              </div>
            </div>

            <div style="height: 12px;"></div>
            <div class="secTitle">Timeout Timer (TOT)</div>

            <div class="row">
              <div class="field">
                <label>TOT</label>
                <div class="toggle">
                  <input type="checkbox" id="tot-enabled" name="tot.tot_enabled"
                    {% if config.get('tot', {}).get('tot_enabled', True) %}checked{% endif %}>
                  <span>Enable</span>
                </div>
              </div>
              <div class="field">
                <label for="tot-time">Duration (s)</label>
                <input type="number" id="tot-time" name="tot.tot_time" min="1" max="600" step="1"
                       value="{{ config.get('tot', {}).get('tot_time', 180) }}">
              </div>
              <div class="field">
                <label for="tot-tone">TOT Tone Pitch (Hz)</label>
                <input type="number" id="tot-tone" name="tot.tot_tone_freq" min="300" max="2000"
                       value="{{ config.get('tot', {}).get('tot_tone_freq', 1200) }}">
              </div>
              <div class="field">
                <label>Lockout</label>
                <div class="toggle">
                  <input type="checkbox" id="tot-lockout" name="tot.tot_lockout_enabled"
                    {% if config.get('tot', {}).get('tot_lockout_enabled', True) %}checked{% endif %}>
                  <span>Enable</span>
                </div>
              </div>
              <div class="field">
                <label for="lockout-time">Lockout (s)</label>
                <input type="number" id="lockout-time" name="tot.tot_lockout_time" min="0" max="600" step="1"
                       value="{{ config.get('tot', {}).get('tot_lockout_time', 180) }}">
              </div>
            </div>

            <div style="height: 12px;"></div>
            <div class="section">
              <h2>PTT Settings</h2>

              <label>PTT Mode:</label>
              <select id="ptt-mode" data-key="ptt.mode">
                <option value="VOX"  {% if config.ptt.mode|upper == 'VOX' %}selected{% endif %}>VOX</option>
                <option value="CM108" {% if config.ptt.mode|upper == 'CM108' %}selected{% endif %}>CM108</option>
              </select>
              <br/>

              <label for="ptt-device">Device Path:</label>
              <input type="text" id="ptt-device" data-key="ptt.device_path" value="{{ config.ptt.device_path or '' }}" />
              <br/>

              <label for="ptt-pin">GPIO Pin:</label>
              <input type="number" id="ptt-pin" data-key="ptt.gpio_pin" min="1" max="40" value="{{ config.ptt.gpio_pin }}" />
              <br/>

              <button type="button" id="test-ptt">Test PTT</button>
            </div>

          </div>
        </div>

      </div>
    </form>
  </div>

  <script>
    // Slider value readouts
    const squelchSlider = document.getElementById('squelch');
    const squelchValue = document.getElementById('squelch-value');
    squelchSlider.addEventListener('input', () => {
      squelchValue.textContent = squelchSlider.value + ' dB';
    });

    const hpToggle = document.getElementById('highpass');
    const hpCutoff = document.getElementById('highpass-cutoff');
    const hpValue = document.getElementById('highpass-value');

    hpToggle.addEventListener('change', () => {
      hpCutoff.disabled = !hpToggle.checked;
    });
    hpCutoff.addEventListener('input', () => {
      hpValue.textContent = hpCutoff.value + ' Hz';
    });

    // Helpers
    function setDot(el, on){
      if(on){ el.classList.add('on'); }
      else { el.classList.remove('on'); }
    }
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

    // Start
    document.getElementById('start-btn').addEventListener('click', () => {
      const formData = new FormData(document.getElementById('config-form'));
      fetch('/start', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'running') {
            document.getElementById('start-btn').disabled = true;
            document.getElementById('stop-btn').disabled = false;
          } else {
            alert('Failed to start: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(err => alert('Start failed: ' + err));
    });

    // Stop
    document.getElementById('stop-btn').addEventListener('click', () => {
      fetch('/stop', { method: 'POST' })
        .then(res => res.json())
        .then(() => {
          document.getElementById('start-btn').disabled = false;
          document.getElementById('stop-btn').disabled = true;
        });
    });

    // These two endpoints aren’t in your web_ui.py yet — leaving the buttons in place,
    // but we won’t crash the UI if they 404.
    document.getElementById('id-btn').addEventListener('click', () => {
      fetch('/manual_id', { method: 'POST' }).catch(()=>{});
    });
    document.getElementById('test-ptt').addEventListener('click', () => {
      fetch('/ptt_test', { method: 'POST' }).catch(()=>{});
    });

    // Status polling
    setInterval(() => {
      fetch('/status', { cache: "no-store" })
        .then(res => res.json())
        .then(status => {
          const txDot = document.getElementById('tx-dot');
          const rxDot = document.getElementById('rx-dot');
          const runPill = document.getElementById('run-pill');
          const pttPill = document.getElementById('ptt-pill');

          if (!status.running) {
            setDot(txDot, false);
            setDot(rxDot, false);
            runPill.textContent = 'Stopped';
            pttPill.textContent = 'PTT: Not Started';

            document.getElementById('level-text').textContent = '-60.0 dB';
            document.getElementById('level-bar').style.height = '0%';

            document.getElementById('clip-alert').classList.add('hidden');
            document.getElementById('limit-alert').classList.add('hidden');

            document.getElementById('tot-lockout-indicator').style.display = 'none';
            document.getElementById('id-indicator').style.display = 'none';
            document.getElementById('tot-text').textContent = '—';
            document.getElementById('next-id-text').textContent = '—';
            document.getElementById('tot-bar').style.width = '0%';
            return;
          }

          // lights
          setDot(txDot, !!status.tx);
          setDot(rxDot, !!status.rx);

          runPill.textContent = status.tx ? 'Running (TX)' : (status.rx ? 'Running (RX)' : 'Running');

          // ptt
          if (status.ptt_status_text) {
            pttPill.textContent = status.ptt_status_text;
            if (status.ptt_status_color) pttPill.style.color = status.ptt_status_color;
          }

          // audio meter
          const db = (typeof status.audio_db === 'number') ? status.audio_db : -60.0;
          document.getElementById('level-text').textContent = db.toFixed(1) + ' dB';
          const levelPercent = clamp((db + 60) / 60 * 100, 0, 100);
          document.getElementById('level-bar').style.height = levelPercent + '%';

          // clip/limit badges
          const clip = document.getElementById('clip-alert');
          const limit = document.getElementById('limit-alert');
          if (status.clipping) clip.classList.remove('hidden'); else clip.classList.add('hidden');
          if (status.limiting) limit.classList.remove('hidden'); else limit.classList.add('hidden');

          // tot lockout badge
          const totBadge = document.getElementById('tot-lockout-indicator');
          if (status.tot_lockout) totBadge.style.display = 'inline-flex';
          else totBadge.style.display = 'none';

          // tot text + progress
          const totEnabled = !!status.tot_enabled;
          const totElapsed = (typeof status.tot_elapsed === 'number') ? status.tot_elapsed : 0;
          const totLimit = (typeof status.tot_limit === 'number') ? status.tot_limit : 0;

          if (!totEnabled) {
            document.getElementById('tot-text').textContent = 'Disabled';
            document.getElementById('tot-bar').style.width = '0%';
          } else if (totLimit > 0) {
            document.getElementById('tot-text').textContent = `${totElapsed.toFixed(1)} / ${totLimit}s`;
            const totPct = clamp((totElapsed / totLimit) * 100, 0, 100);
            document.getElementById('tot-bar').style.width = totPct + '%';
          } else {
            document.getElementById('tot-text').textContent = `${totElapsed.toFixed(1)}s`;
            document.getElementById('tot-bar').style.width = '0%';
          }

          // ID indicator + next id time
          const idBadge = document.getElementById('id-indicator');
          if (status.sending_id) idBadge.style.display = 'inline-flex';
          else idBadge.style.display = 'none';

          if (typeof status.next_id_in === 'number') {
            document.getElementById('next-id-text').textContent = Math.ceil(status.next_id_in) + 's';
          } else {
            document.getElementById('next-id-text').textContent = '—';
          }
        });
    }, 500);

    let targetRxDb = -60, shownRxDb = -60;
    let targetTxDb = -60, shownTxDb = -60;

    function smoothStep(shown, target){
      const attack = 0.35;   // fast rise
      const release = 0.08;  // slow fall
      const a = (target > shown) ? attack : release;
      return shown + (target - shown) * a;
    }

    function dbToPct(db){
      return Math.min(100, Math.max(0, (db + 60) / 60 * 100));
    }

    function meterTick(){
      shownRxDb = smoothStep(shownRxDb, targetRxDb);
      shownTxDb = smoothStep(shownTxDb, targetTxDb);

      // If you have one bar, choose RX or TX. If you have two bars, map both.
      document.getElementById('level-bar').style.height = dbToPct(shownRxDb) + '%';
      document.getElementById('level-text').textContent = shownRxDb.toFixed(1) + ' dB';

      requestAnimationFrame(meterTick);
    }
    requestAnimationFrame(meterTick);

    setInterval(() => {
      fetch('/meter', { cache: "no-store" })
        .then(r => r.json())
        .then(m => {
          if (!m.running) { targetRxDb = -60; targetTxDb = -60; return; }
          targetRxDb = (typeof m.rx_db === 'number') ? m.rx_db : -60;
          targetTxDb = (typeof m.tx_db === 'number') ? m.tx_db : -60;

          document.getElementById('clip-alert').style.display = m.clipping ? 'inline' : 'none';
          document.getElementById('limit-alert').style.display = m.limiting ? 'inline' : 'none';
        });
    }, 50);


  </script>

</body>
</html>
