name: Cross-Platform KrakenRelay Builds

on:
  push:
    branches: [ main ]
    tags: [ "v*.*.*" ]
  workflow_dispatch:

env:
  APP_NAME: krakenrelay
  PYTHON_VERSION: "3.11"

jobs:
  windows:
    name: ðŸªŸ Windows (PyInstaller)
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Upgrade build tooling (pip/setuptools/wheel)
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Create CI requirements (drop stdlib logging)
        shell: bash
        run: |
          python - <<'PY'
          import pathlib, re
          req = pathlib.Path("requirements.txt").read_text().splitlines()
          req = [ln for ln in req if not re.match(r'^\s*logging\s*==', ln)]
          pathlib.Path("requirements.ci.txt").write_text("\n".join(req) + "\n")
          print("Wrote requirements.ci.txt")
          PY

      - name: Install dependencies + PyInstaller
        run: |
          python -m pip install -r requirements.ci.txt pyinstaller

      - name: Build CFFI DSP module
        shell: bash
        run: |
          cd kraken_dsp
          python build_dsp.py

      - name: Build EXE (includes templates/static/config)
        run: |
          pyinstaller --noconfirm --clean --onefile ^
            --name "%APP_NAME%" ^
            --collect-all kraken_dsp ^
            --hidden-import kraken_dsp._kraken_dsp ^
            --add-data "templates;templates" ^
            --add-data "static;static" ^
            --add-data "config.yaml;." ^
            main.py

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows
          path: dist/${{ env.APP_NAME }}.exe


  macos:
    name: ðŸ macOS (PyInstaller)
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install PortAudio (for PyAudio)
        run: |
          brew update
          brew install portaudio pkg-config

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Upgrade build tooling (pip/setuptools/wheel)
        run: |
          python -m pip install --upgrade pip setuptools wheel

      - name: Create CI requirements (drop stdlib logging)
        shell: bash
        run: |
          python - <<'PY'
          import pathlib, re
          req = pathlib.Path("requirements.txt").read_text().splitlines()
          req = [ln for ln in req if not re.match(r'^\s*logging\s*==', ln)]
          pathlib.Path("requirements.ci.txt").write_text("\n".join(req) + "\n")
          print("Wrote requirements.ci.txt")
          PY

      - name: Install dependencies + PyInstaller
        run: |
          python -m pip install -r requirements.ci.txt pyinstaller

      - name: Build CFFI DSP module
        shell: bash
        run: |
          cd kraken_dsp
          python build_dsp.py

      - name: Build macOS binary (includes templates/static/config)
        shell: bash
        run: |
          pyinstaller --noconfirm --clean --onefile \
            --name "${APP_NAME}" \
            --collect-all kraken_dsp \
            --hidden-import kraken_dsp._kraken_dsp \
            --add-data "templates:templates" \
            --add-data "static:static" \
            --add-data "config.yaml:." \
            main.py

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macos
          path: dist/${{ env.APP_NAME }}


  linux:
    name: ðŸ§ Linux (Debian Bookworm PyInstaller)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      # Build inside Debian so the output is Debian-ish compatible (not â€œUbuntu 24-onlyâ€)
      - name: Build Linux binary inside Debian (PyInstaller)
        shell: bash
        run: |
          docker run --rm \
            -v "$PWD:/src" -w /src \
            debian:bookworm bash -lc '
              set -euo pipefail
              apt-get update
              apt-get install -y --no-install-recommends \
                python3 python3-venv python3-pip \
                build-essential gcc pkg-config \
                portaudio19-dev libasound2-dev libffi-dev \
              && rm -rf /var/lib/apt/lists/*

              python3 -m venv /opt/venv
              . /opt/venv/bin/activate

              python -m pip install --upgrade pip setuptools wheel

              python - <<'"'"'PY'"'"'
              import pathlib, re
              req = pathlib.Path("requirements.txt").read_text().splitlines()
              req = [ln for ln in req if not re.match(r"^\\s*logging\\s*==", ln)]
              pathlib.Path("requirements.ci.txt").write_text("\\n".join(req) + "\\n")
              print("Wrote requirements.ci.txt")
              PY

              python -m pip install -r requirements.ci.txt pyinstaller

              (cd kraken_dsp && python build_dsp.py)

              pyinstaller --noconfirm --clean --onefile \
                --name krakenrelay \
                --collect-all kraken_dsp \
                --hidden-import kraken_dsp._kraken_dsp \
                --add-data "templates:templates" \
                --add-data "static:static" \
                --add-data "config.yaml:." \
                main.py
            '

          # Fix ownership so upload-artifact can read it cleanly
          sudo chown -R "$(id -u):$(id -g)" dist build *.spec || true

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux
          path: dist/${{ env.APP_NAME }}


  docker:
    name: ðŸ™ Docker Image (tags only â†’ push GHCR)
    runs-on: ubuntu-latest
    needs: [linux]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU (multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # IMPORTANT: this assumes you have a Dockerfile at repo root
      - name: Build and push (amd64 + arm64)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.APP_NAME }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ env.APP_NAME }}:${{ github.ref_name }}


  release:
    name: ðŸ“¦ GitHub Release (tags only)
    runs-on: ubuntu-latest
    needs: [windows, macos, linux]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      actions: read
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release & upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/${{ env.APP_NAME }}-windows/${{ env.APP_NAME }}.exe
            artifacts/${{ env.APP_NAME }}-macos/${{ env.APP_NAME }}
            artifacts/${{ env.APP_NAME }}-linux/${{ env.APP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
